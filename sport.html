<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />

  <title>Hemera Networks – Sport</title>

  <!-- Inject shared head bits (favicon, main CSS, etc.) -->
  <script>
    fetch('/head.html')
      .then(r => r.text())
      .then(fragment => {
        document.head.insertAdjacentHTML('beforeend', fragment);
      })
      .catch(console.error);
  </script>

  <!-- 
    FORCE a 4-column grid for sport-page only.
    We use a more specific selector (#sport-subsections .sport-grid) 
    and !important so that it overrides the external style.css rule.
  -->
  <style>
    #sport-subsections .sport-section .sport-grid {
      display: grid !important;
      grid-template-columns: repeat(4, 1fr) !important;
      gap: 1rem !important;
      margin-bottom: 3rem !important;
    }
  </style>
</head>
<body>
  <!-- Header & footer get injected by script.js -->
  <div id="header-container"></div>

  <main class="main-content">
    <h2 class="section-title">Sport</h2>

    <!-- Container where all subsections (e.g. Football, Premier League, Other) go -->
    <div id="sport-subsections"></div>
  </main>

  <div id="footer-container"></div>

  <!-- Core site script (header/footer, weather cards, map, etc.) -->
  <script src="/script.js" defer></script>

  <!-- Inline logic to build Sport subsections using each article’s <a class="category-tag">…</a> -->
  <script>
    document.addEventListener('DOMContentLoaded', async () => {
      // 1) Fetch index.html so we can collect all .sport-article cards
      let indexText;
      try {
        const resp = await fetch('/index.html');
        indexText = await resp.text();
      } catch (err) {
        console.error('Error fetching index.html:', err);
        return;
      }

      // 2) Parse index.html into a DOM
      const parser = new DOMParser();
      const indexDoc = parser.parseFromString(indexText, 'text/html');

      // 3) Grab every .sport-article element from index.html
      const sportCards = Array.from(indexDoc.querySelectorAll('.sport-article'));

      // 4) Prepare a buckets object mapping tagName → [card, …]
      const buckets = {};

      // 5) For each .sport-article, fetch its article page to read <a class="category-tag">…</a>
      const tasks = sportCards.map(async card => {
        const linkEl = card.querySelector('a');
        if (!linkEl) {
          return { card, tags: [] }; // no link → treat as “Other”
        }
        const articleHref = linkEl.getAttribute('href');
        const articleURL = new URL(articleHref, window.location.origin).href;

        try {
          const artResp = await fetch(articleURL);
          const artText = await artResp.text();
          const artDoc  = parser.parseFromString(artText, 'text/html');
          const tagEls  = artDoc.querySelectorAll('a.category-tag');
          const tags    = Array.from(tagEls).map(el => el.textContent.trim());
          return { card, tags };
        } catch (err) {
          console.error(`Error fetching/parsing ${articleURL}:`, err);
          return { card, tags: [] };
        }
      });

      // 6) Wait for all article-fetch tasks
      const results = await Promise.all(tasks);

      // 7) Populate buckets
      results.forEach(({ card, tags }) => {
        if (tags.length > 0) {
          tags.forEach(tagName => {
            if (!buckets[tagName]) buckets[tagName] = [];
            buckets[tagName].push(card);
          });
        } else {
          if (!buckets['Other']) buckets['Other'] = [];
          buckets['Other'].push(card);
        }
      });

      // 8) Get the container for subsections
      const container = document.getElementById('sport-subsections');

      // 9) Sort by number of cards (descending) and render each subsection
      Object.entries(buckets)
        .sort((a, b) => b[1].length - a[1].length)
        .forEach(([subcatName, cardList]) => {
          // a) Create a <section class="sport-section">
          const section = document.createElement('section');
          section.classList.add('sport-section');

          // b) Subsection heading <h3>
          const heading = document.createElement('h3');
          heading.textContent = `${subcatName} (${cardList.length})`;
          heading.style.marginTop = '2rem';
          heading.style.marginBottom = '1rem';
          heading.style.color = 'var(--black)';
          heading.style.fontSize = '1.5rem';
          heading.style.borderLeft = '6px solid var(--gold)';
          heading.style.paddingLeft = '1rem';
          section.appendChild(heading);

          // c) Create a grid container for up to 4 columns
          const grid = document.createElement('div');
          grid.classList.add('sport-grid');

          // d) Clone & append each card into the grid
          cardList.forEach(origCard => {
            const clone = origCard.cloneNode(true);
            grid.appendChild(clone);
          });

          section.appendChild(grid);
          container.appendChild(section);
        });
    });
  </script>
</body>
</html>
